var Civilization;Civilization={Entity:{},Game:{},Util:{}},Civilization.Language={PLAYER_TURN:"Click on any tile to take control of it",CPU_TURN:"Waiting for other players to move...",GAME_FINISHED:"Game over! {0} is the winner with {1} points"},Function.prototype.property=function(a,b){return Object.defineProperty(this.prototype,a,b)},Civilization.Util.Math={randomIntBetween:function(a,b){return Math.floor(Math.random()*(b-a+1)+a)}},String.prototype.format=function(){var a,b,c;return a=arguments,c=/\{(\d+)\}/g,b=function(b,c){return c in a?a[c]:b},this.replace(c,b)},Civilization.Entity.Player=function(){function a(a,b){var c;this.name=a,this.mainColor=b,this.id=this.mainColor,this.fillColor=this.mainColor,c=tinycolor.darken(this.mainColor.toString(16),30),this.borderColor=parseInt(c.toHex(),16)}return a}();var _ref,__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};Civilization.Entity.CPU=function(a){function b(){return _ref=b.__super__.constructor.apply(this,arguments)}return __extends(b,a),b.prototype.chooseTile=function(a){for(var b;!b||b.owner;)b=a.getRandomTile();return b},b}(Civilization.Entity.Player),Civilization.Entity.Tile=function(){function a(){this.graphics=new PIXI.Graphics}return a.prototype.fillColor=15920612,a.prototype.borderColor=14275015,a.property("coords",{get:function(){return{x:this.x/TILE_SIZE,y:this.y/TILE_SIZE}}}),a.property("owner",{get:function(){return this._owner},set:function(a){return this._owner=a,this.fillColor=this._owner.fillColor,this.borderColor=this._owner.borderColor}}),a.prototype.draw=function(a,b){return null!=a&&null!=b?(this.x=a,this.y=b):this.graphics.clear(),this.graphics.beginFill(this.fillColor),this.graphics.lineStyle(1,this.borderColor,1),this.graphics.drawRect(this.x,this.y,TILE_SIZE,TILE_SIZE),this.graphics.endFill()},a.prototype.getDisplayObject=function(){return this.graphics},a}(),Civilization.Game.Logger=function(){function a(){}return a.prototype.history=[],a.prototype._log=function(a,b){return console[a].apply(console,Array.prototype.slice.call(b)),this.history.push({level:a,arguments:b})},a.prototype.log=function(){return this._log("log",arguments)},a.prototype.info=function(){return this._log("info",arguments)},a.prototype.warn=function(){return this._log("warn",arguments)},a.prototype.error=function(){return this._log("error",arguments)},a}(),Civilization.Game.Map=function(){function a(a,b){this.xTiles=a,this.yTiles=b,this.resetTiles(),this.texture=new PIXI.RenderTexture(GAME_WIDTH,GAME_HEIGHT),this.DO=new PIXI.Sprite(this.texture),this.DO.hitArea=new PIXI.Rectangle(0,0,GAME_WIDTH,GAME_HEIGHT),this.DO.interactive=!0}return a.prototype.tiles=[],a.prototype.ownedTiles=0,a.prototype.drawTile=function(a,b,c){return a.draw(b,c),this.texture.render(a.getDisplayObject())},a.prototype.setTileOwner=function(a,b){return a.owner||this.ownedTiles++,a.owner=b,this.drawTile(a)},a.prototype.getTile=function(a,b){var c;return null!=(c=this.tiles[b])?c[a]:void 0},a.prototype.getTileAtCoords=function(a,b){var c,d,e,f;return c=Math.floor(a/TILE_SIZE)*TILE_SIZE,d=Math.floor(b/TILE_SIZE)*TILE_SIZE,e=c/TILE_SIZE,f=d/TILE_SIZE,this.getTile(e,f)},a.prototype.getRandomTile=function(){var a,b;return a=Civilization.Util.Math.randomIntBetween(0,this.xTiles-1),b=Civilization.Util.Math.randomIntBetween(0,this.yTiles-1),this.getTile(a,b)},a.prototype.expandTiles=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o;for(n=this.tiles,o=[],j=l=0,m=n.length;m>l;j=++l)g=n[j],o.push(function(){var l,m,n,o,p,q,r;for(r=[],i=l=0,n=g.length;n>l;i=++l){for(h=g[i],c=[[i,j-1],[i,j+1],[i-1,j],[i+1,j]],f=3,b={},m=0,o=c.length;o>m;m++)q=c[m],d=q[0],e=q[1],a=this.getTile(d,e),a&&a.owner&&(null==b[p=a.owner.id]&&(b[p]={owner:a.owner,count:0}),b[a.owner.id].count++);r.push(function(){var c;c=[];for(k in b){if(a=b[k],a.count>=f&&a.owner!==h.owner){LOGGER.log("Tile at ["+d+", "+e+"] taken by "+a.owner.name),this.setTileOwner(h,a.owner);break}c.push(void 0)}return c}.call(this))}return r}.call(this));return o},a.prototype.resetTiles=function(){var a,b,c,d;for(c=this.yTiles,d=[];c--;){for(b=[],a=this.xTiles;a--;)b.push(new Civilization.Entity.Tile);d.push(this.tiles.push(b))}return d},a.prototype.draw=function(){var a,b,c,d,e,f,g,h;for(g=this.tiles,h=[],d=e=0,f=g.length;f>e;d=++e)a=g[d],h.push(function(){var e,f,g;for(g=[],c=e=0,f=a.length;f>e;c=++e)b=a[c],g.push(this.drawTile(b,c*TILE_SIZE,d*TILE_SIZE));return g}.call(this));return h},a.prototype.getDisplayObject=function(){return this.DO},a}(),Civilization.Game.Manager=function(){function a(a,b){var c,d=this;this.player=a,this.cpus=b,this.renderer=PIXI.autoDetectRenderer(GAME_WIDTH,GAME_HEIGHT),this.stage=new PIXI.Stage(16777215,c=!0),this.info=new Civilization.Game.InfoBar,this.map=new Civilization.Game.Map(X_TILES,Y_TILES),this.map.getDisplayObject().click=function(b){var c;if(d.state.is("player")&&(c=d.map.getTileAtCoords(b.global.x,b.global.y),!c.owner))return LOGGER.log(""+d.player.name+" placed tile at ["+c.coords.x+", "+c.coords.y+"]"),d.map.setTileOwner(c,d.player),d.updateState(),d.state.finishTurn(a)},this.state=Civilization.Game.State.create(),this.state.onplayer=function(){return d.info.setText(Civilization.Language.PLAYER_TURN),d.updateState()},this.state.onentercpu=function(){var a,b,c,e,f;for(d.info.setText(Civilization.Language.CPU_TURN),d.updateState(),f=d.cpus,c=0,e=f.length;e>c&&(a=f[c],!d.state.is("finished"));c++)b=a.chooseTile(d.map),LOGGER.log(""+a.name+" placed tile at ["+b.coords.x+", "+b.coords.y+"]"),d.map.setTileOwner(b,a),d.map.expandTiles(),d.updateState(),d.state.finishTurn(a);return d.state.is("finished")?void 0:d.state.finishRound()},this.state.onfinishTurn=function(){return d.map.ownedTiles===X_TILES*Y_TILES?d.state.finishGame():void 0},this.state.onenterfinished=function(){var a,b,c,e,f,g,h,i,j,k,l,m;for(e={},m=d.map.tiles,h=0,j=m.length;j>h;h++)for(b=m[h],i=0,k=b.length;k>i;i++)f=b[i],null==e[l=f.owner.id]&&(e[l]={owner:f.owner,score:0}),e[f.owner.id].score+=10;a=[];for(g in e)c=e[g],LOGGER.log(""+c.owner.name+" scored "+c.score),a.push(c);return a.sort(function(a,b){return a.score<b.score?-1:a.score>b.score?1:0}).reverse(),d.info.setText(Civilization.Language.GAME_FINISHED.format(a[0].owner.name,a[0].score)),d.updateState()}}var b;return b=Civilization.Game.Map,a.prototype.start=function(){return this.updateState(),this.info.setText(Civilization.Language.PLAYER_TURN),this.stage.addChild(this.map.getDisplayObject()),this.stage.addChild(this.info.getDisplayObject()),this.map.draw(),this.updateState()},a.prototype.updateState=function(){return this.renderer.render(this.stage)},a}(),Civilization.Game.InfoBar=function(){function a(){this.text=new Civilization.Game.Text("",{font:"10pt Monospace",fill:"#000000"}),this.text.anchor.x=.5,this.text.position.x=GAME_WIDTH/2,this.text.position.y=GAME_HEIGHT-INFOBAR_SIZE+5}return a.prototype.setText=function(a){return this.text.setText(a)},a.prototype.getDisplayObject=function(){return this.text},a}(),Civilization.Game.Statistics=function(){function a(){var a,b;a={x:10,y:10},b=140,this.text=new Civilization.Game.Text("",{wordWrap:!0,wordWrapWidth:b}),this.text.anchor.x=1,this.text.position.x=GAME_WIDTH-a.x,this.text.position.y=a.y,this.update()}return a.prototype.turns=0,a.prototype.update=function(){return this.text.setText("Turns: "+this.turns)},a.prototype.getDisplayObject=function(){return this.text},a}(),Civilization.Game.State=function(){function a(){}return a.create=function(){var a;return a=StateMachine.create({initial:"player",events:[{name:"finishTurn",from:"player",to:"cpu"},{name:"finishTurn",from:"cpu",to:"cpu"},{name:"finishRound",from:["cpu","player"],to:"player"},{name:"finishGame",from:"*",to:"finished"}]})},a}();var __hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};Civilization.Game.Text=function(a){function b(a,c){var d,e,f;null==a&&(a=""),null==c&&(c={}),e={font:"16px Monospace",align:"left",fill:"rgba(80, 80, 80, 0.65)",stroke:"rgba(0, 0, 0, 0.4)",strokeThickness:1};for(d in c)f=c[d],e[d]=f;b.__super__.constructor.call(this,a,e)}return __extends(b,a),b}(PIXI.Text);var GAME_HEIGHT,GAME_WIDTH,INFOBAR_SIZE,LOGGER,Manager,TILE_SIZE,X_TILES,Y_TILES,cpuColors,cpuCount,cpus,i,player,_i;for(INFOBAR_SIZE=30,TILE_SIZE=40,X_TILES=16,Y_TILES=12,GAME_WIDTH=TILE_SIZE*X_TILES,GAME_HEIGHT=TILE_SIZE*Y_TILES+INFOBAR_SIZE,LOGGER=new Civilization.Game.Logger,cpuCount=2,cpuColors=[6076508,15773006,14242639,6013150],cpus=[],i=_i=1;cpuCount>=1?cpuCount>=_i:_i>=cpuCount;i=cpuCount>=1?++_i:--_i)cpus.push(new Civilization.Entity.CPU("CPU "+i,cpuColors[i-1]));player=new Civilization.Entity.Player("Player 1",4361162),LOGGER.log(""+cpus.length+" CPU players have joined the game"),LOGGER.log(""+player.name+" has joined the game"),Manager=new Civilization.Game.Manager(player,cpus),document.body.appendChild(Manager.renderer.view),Manager.start();